
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>SmartCart</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background-color: #0d1b2a;
      color: #ffffff;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-bottom: 40px;
    }

    header {
      width: 100%;
      max-width: 1000px;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 16px;
      margin-bottom: 10px;
    }

    #totalSuperior {
      font-size: 3.2rem;
      font-weight: bold;
      color: #00ffea;
      text-align: center;
    }

    h2 {
      font-size: 2.2rem;
      color: #00b4d8;
      text-align: center;
      margin: 8px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    h2::before {
      content: 'üõí';
      font-size: 1.8rem;
    }

    .mainContent {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      flex-wrap: wrap;
      width: 100%;
      max-width: 1000px;
      padding: 10px 16px;
      gap: 20px;
    }

    #cameraContainer {
      position: relative;
      flex: 1 1 45%;
      min-width: 300px;
      max-width: 420px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 0 12px #0077b6;
    }

    video, canvas {
      width: 100%;
      display: block;
    }

    #focusBox {
      position: absolute;
      top: 35%;
      left: 0;
      width: 100%;
      height: 30%;
      border: 2px dashed #00b4d8;
      animation: pulse 1.5s infinite;
      pointer-events: none;
    }

    @keyframes pulse {
      0%, 100% { border-color: #00b4d8; }
      50% { border-color: #90e0ef; }
    }

    .container {
      flex: 1 1 45%;
      max-width: 420px;
    }

    .box {
      background-color: #1b263b;
      border: 1px solid #00b4d8;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 0 10px #00b4d855;
    }

    .opcao {
      background: #102030;
      border: 1px solid #00b4d8;
      border-radius: 10px;
      padding: 20px;
      margin: 16px 0;
      text-align: center;
    }

    .opcao strong {
      display: block;
      margin-bottom: 12px;
      font-size: 1.3rem;
    }

    button {
      background-color: #00b4d8;
      color: #000;
      border: none;
      padding: 22px 30px;
      font-weight: 600;
      font-size: 1.6rem;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.2s ease;
      width: 100%;
      max-width: 350px;
      margin: 14px auto 0;
      display: block;
    }

    button:hover {
      background-color: #90e0ef;
      transform: scale(1.02);
    }

    ul {
      padding-left: 20px;
      font-size: 1.1rem;
    }

    li {
      margin-bottom: 10px;
    }

    .actions {
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
      gap: 12px;
      flex-wrap: wrap;
    }

    .actions button {
      flex: 1 1 45%;
      font-size: 1.3rem;
      padding: 18px 12px;
      max-width: none;
    }
  </style>
</head>
<body>
  <header>
    <div id="totalSuperior">üßæ R$ 0,00</div>
  </header>

  <h2>SmartCart</h2>

  <div class="mainContent">
    <div id="cameraContainer">
      <video id="video" autoplay playsinline></video>
      <canvas id="canvas" style="display:none;"></canvas>
      <div id="focusBox"></div>
    </div>

    <div class="container">
      <div class="actions">
        <button onclick="zerarTotal()">üóëÔ∏è Zerar Total</button>
        <button onclick="desfazerUltimo()">‚Ü©Ô∏è Desfazer √öltimo</button>
      </div>

      <div id="resultado" class="box" style="display:none;"></div>

      <div id="listaProdutos" class="box" style="display:none;">
        <h3>üõí Produtos Adicionados</h3>
        <ul id="produtos"></ul>
      </div>
    </div>
  </div>

  <script>
    let ocrAtivo = true;
    let produtosConfirmados = [];
    let historicoTotais = [];
    let total = 0;

    function detectarMelhoresNomes(textoOCR) {
      const linhas = textoOCR.split('\n').map(l => l.trim()).filter(l => l.length > 0);
      const marcas = ['Italac', 'Tio Jo√£o', 'Ninho', 'Qualit√°', 'Sadia', 'Nestl√©'];
      const unidades = ['kg', 'g', 'ml', 'l', 'L', 'un', 'und'];
      const palavrasBanidas = ['val', 'validade', 'promo√ß√£o', 'data', 'expira', 'venc', 'fabric'];
      const opcoes = [];
      const precosDetectados = [];

      for (const linha of linhas) {
        const linhaLimpa = linha.toLowerCase();
        const temPreco = /(r\$\s*|por\s*|pre√ßo\s*)?\d{1,3}[.,]\d{2}/.test(linhaLimpa);

        const precos = linha.match(/(r\$\s?)?(\d{1,3}[.,]\d{2})/gi);
        if (precos && temPreco && !palavrasBanidas.some(p => linhaLimpa.includes(p))) {
          precos.forEach(p => {
            const num = p.replace(/[^0-9,\.]/g, '').replace(',', '.');
            const val = parseFloat(num);
            if (val > 0.5 && val < 500) precosDetectados.push(val);
          });
        }

        let pontos = 0;
        const palavras = linha.split(' ');
        if (palavras.length >= 2) pontos += 2;
        if (marcas.some(m => linha.includes(m))) pontos += 3;
        if (unidades.some(u => linhaLimpa.includes(u))) pontos += 2;
        if (!palavrasBanidas.some(p => linhaLimpa.includes(p))) pontos += 2;
        if (linha === linha.toUpperCase()) pontos += 1;

        opcoes.push({ texto: linha, pontos });
      }

      opcoes.sort((a, b) => b.pontos - a.pontos);
      const precoFinal = precosDetectados.sort((a, b) => a - b)[0];
      return {
        opcoes: opcoes.slice(0, 3),
        preco: precoFinal ? parseFloat(precoFinal.toFixed(2)) : null
      };
    }

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const resultadoDiv = document.getElementById('resultado');
    const listaDiv = document.getElementById('listaProdutos');
    const listaUL = document.getElementById('produtos');
    const totalSuperior = document.getElementById('totalSuperior');
    const context = canvas.getContext('2d');

    async function iniciarCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
      video.srcObject = stream;
    }

    async function processarOCR() {
      if (!ocrAtivo || !video.videoWidth || !video.videoHeight) return;
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);

      const focoX = 0;
      const focoY = canvas.height * 0.35;
      const focoLarg = canvas.width;
      const focoAlt = canvas.height * 0.3;

      const imageData = context.getImageData(focoX, focoY, focoLarg, focoAlt);
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = focoLarg;
      tempCanvas.height = focoAlt;
      tempCanvas.getContext('2d').putImageData(imageData, 0, 0);

      const dataURL = tempCanvas.toDataURL('image/png');
      const { data: { text } } = await Tesseract.recognize(dataURL, 'por');
      const resultado = detectarMelhoresNomes(text);

      if (!resultado.preco) return;

      ocrAtivo = false;
      let html = `<strong>üí∞ Pre√ßo:</strong> R$ ${resultado.preco.toFixed(2).replace('.', ',')}<br><br>`;
      resultado.opcoes.forEach(op => {
        html += `
          <div class="opcao">
            <strong>${op.texto}</strong>
            <button onclick="confirmarProduto('${op.texto}', ${resultado.preco})">Adicionar</button>
          </div>
        `;
      });

      html += `<button onclick="excluirProduto()">Excluir</button>`;
      resultadoDiv.innerHTML = html;
      resultadoDiv.style.display = 'block';
    }

    function confirmarProduto(nome, preco) {
      if (historicoTotais.length >= 10) historicoTotais.shift();
      historicoTotais.push({ nome, preco });
      produtosConfirmados.push({ nome, preco });
      total += preco;
      atualizarLista();
      resultadoDiv.style.display = 'none';
      ocrAtivo = true;
    }

    function excluirProduto() {
      resultadoDiv.style.display = 'none';
      ocrAtivo = true;
    }

    function atualizarLista() {
      listaUL.innerHTML = '';
      produtosConfirmados.forEach(p => {
        const item = document.createElement('li');
        item.textContent = `${p.nome} ‚Äì R$ ${p.preco.toFixed(2).replace('.', ',')}`;
        listaUL.appendChild(item);
      });
      totalSuperior.textContent = `üßæ R$ ${total.toFixed(2).replace('.', ',')}`;
      listaDiv.style.display = 'block';
    }

    function zerarTotal() {
      produtosConfirmados = [];
      total = 0;
      historicoTotais = [];
      atualizarLista();
      listaDiv.style.display = 'none';
    }

    function desfazerUltimo() {
      const ultimo = historicoTotais.pop();
      if (ultimo) {
        const index = produtosConfirmados.findIndex(p => p.nome === ultimo.nome && p.preco === ultimo.preco);
        if (index !== -1) {
          produtosConfirmados.splice(index, 1);
          total -= ultimo.preco;
          atualizarLista();
        }
      }
    }

    async function loopOCR() {
      await processarOCR();
      setTimeout(loopOCR, 2000);
    }

    iniciarCamera().then(loopOCR);
  </script>
</body>
</html>
