
<!-- HTML com Firebase, OCR e envio para Firestore -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>SmartCart OCR + Firestore</title>
  <style>
    video, canvas {
      display: block;
      margin: 10px auto;
      max-width: 90%;
    }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, updateDoc, doc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAfhmfxYmQ0gO3ACrCHeNZx83khMrDUD8U",
      authDomain: "smartcart-app-dc796.firebaseapp.com",
      projectId: "smartcart-app-dc796",
      storageBucket: "smartcart-app-dc796.appspot.com",
      messagingSenderId: "903830223010",
      appId: "1:903830223010:web:9241e79644d2039c3e7ffb"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.enviarProdutoParaFirestore = async function(produto, preco, mercado, usuario_id) {
      const registro = {
        produto: produto,
        preco: parseFloat(preco),
        mercado: mercado,
        data: new Date(),
        usuario_id: usuario_id,
        pontos: 1,
        validador_ids: [usuario_id]
      };

      try {
        await addDoc(collection(db, "precos_brutos"), registro);
        alert("‚úÖ Produto enviado com sucesso!");
      } catch (erro) {
        alert("‚ùå Erro ao enviar: " + erro.message);
      }
    }

    window.carregarRanking = async function() {
      const lista = document.getElementById("ranking");
      lista.innerHTML = "<li>Carregando...</li>";

      const q = query(
        collection(db, "precos_brutos"),
        orderBy("preco", "asc"),
        limit(5)
      );

      try {
        const querySnapshot = await getDocs(q);
        lista.innerHTML = "";
        querySnapshot.forEach(docSnap => {
          const dados = docSnap.data();
          const item = document.createElement("li");
          item.textContent = `${dados.produto.toUpperCase()} - R$ ${dados.preco.toFixed(2)} (${dados.mercado})`;
          lista.appendChild(item);
        });
      } catch (erro) {
        lista.innerHTML = `<li>Erro ao carregar ranking: ${erro.message}</li>`;
      }
    }

    window.carregarValidacoes = async function() {
      const validacoes = document.getElementById("validacoes");
      validacoes.innerHTML = "<li>Carregando...</li>";

      const q = query(collection(db, "precos_brutos"), orderBy("data", "desc"), limit(5));

      try {
        const querySnapshot = await getDocs(q);
        validacoes.innerHTML = "";
        querySnapshot.forEach(docSnap => {
          const dados = docSnap.data();
          const li = document.createElement("li");
          li.innerHTML = `${dados.produto} - R$${dados.preco.toFixed(2)} - ${dados.mercado} - Pontos: ${dados.pontos} ` +
            `<button onclick="validar('${docSnap.id}', 1)">üëç</button> ` +
            `<button onclick="validar('${docSnap.id}', -1)">üëé</button>`;
          validacoes.appendChild(li);
        });
      } catch (erro) {
        validacoes.innerHTML = `<li>Erro ao carregar: ${erro.message}</li>`;
      }
    }

    window.validar = async function(id, delta) {
      const ref = doc(db, "precos_brutos", id);
      try {
        const snap = await getDocs(query(collection(db, "precos_brutos")));
        snap.forEach(async (docSnap) => {
          if (docSnap.id === id) {
            const dados = docSnap.data();
            const novoTotal = (dados.pontos || 0) + delta;
            await updateDoc(ref, { pontos: novoTotal });
            alert("Voto computado com sucesso");
            carregarValidacoes();
          }
        });
      } catch (erro) {
        alert("Erro ao votar: " + erro.message);
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js"></script>
</head>
<body>
  <h1>SmartCart com OCR + Firestore</h1>

  <video id="camera" autoplay playsinline></video>
  <canvas id="canvas" style="display:none;"></canvas>
  <button onclick="capturarTexto()">üì∏ Capturar e Enviar</button>

  <h2>Ranking de Menores Pre√ßos</h2>
  <button onclick="carregarRanking()">üîÅ Atualizar</button>
  <ul id="ranking"></ul>

  <h2>Valida√ß√£o de Pre√ßos</h2>
  <button onclick="carregarValidacoes()">üîÉ Atualizar</button>
  <ul id="validacoes"></ul>

  <script>
    const video = document.getElementById('camera');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
      .then(stream => video.srcObject = stream)
      .catch(err => alert('Erro ao acessar c√¢mera: ' + err));

    function capturarTexto() {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);
      Tesseract.recognize(canvas, 'por', {
        logger: m => console.log(m)
      }).then(({ data: { text } }) => {
        const precoRegex = /R?\$?\s?(\d+[\.,]?\d{0,2})/gi;
        const match = precoRegex.exec(text);
        if (match) {
          const preco = match[1].replace(',', '.');
          const produto = "Produto escaneado";
          enviarProdutoParaFirestore(produto, preco, "Mercado Local", "scanner01");
        } else {
          alert("Pre√ßo n√£o identificado na imagem");
        }
      });
    }
  </script>
</body>
</html>
