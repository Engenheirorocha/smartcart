
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>SmartCart OCR Único</title>
  <style>
    body { font-family: sans-serif; text-align: center; }
    video { width: 90%; max-width: 500px; border-radius: 10px; }
    #cameraContainer { position: relative; display: inline-block; }
    #retangulo {
      position: absolute; top: 50%; left: 50%;
      width: 60%; height: 30%;
      transform: translate(-50%, -50%);
      border: 2px solid red; border-radius: 10px;
      pointer-events: none;
    }
    li { margin: 5px; padding: 8px; background: #eee; border-radius: 6px; }
    button { margin: 0 5px; padding: 6px 12px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js"></script>
</head>
<body>
  <h1>SmartCart OCR Único</h1>
  <div id="cameraContainer">
    <video id="camera" autoplay playsinline></video>
    <div id="retangulo"></div>
  </div>
  <canvas id="canvas" style="display:none;"></canvas>
  <h3>Total: R$ <span id="total">0.00</span></h3>
  <ul id="lista"></ul>

  <script>
    const video = document.getElementById("camera");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const lista = document.getElementById("lista");
    const totalDisplay = document.getElementById("total");

    let total = 0;
    let lidos = [];
    let ocrAtivo = true;

    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then(stream => video.srcObject = stream)
      .catch(err => alert("Erro: " + err));

    function capturaOCRPrecos() {
      if (!video.videoWidth || !ocrAtivo) return;
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      const rw = canvas.width * 0.6;
      const rh = canvas.height * 0.3;
      const rx = (canvas.width - rw) / 2;
      const ry = (canvas.height - rh) / 2;

      ctx.drawImage(video, rx, ry, rw, rh, 0, 0, rw, rh);

      ocrAtivo = false;

      Tesseract.recognize(canvas, 'por', { logger: m => console.log(m) })
        .then(({ data: { text } }) => {
          const regex = /(?:R\$|R\s*\$)?\s*(\d{1,3}(?:[\.,]\d{2})?)/gi;
          let precos = {};
          let match;
          while ((match = regex.exec(text)) !== null) {
            let preco = parseFloat(match[1].replace(',', '.'));
            if (!isNaN(preco)) {
              preco = parseFloat(preco.toFixed(2));
              precos[preco] = (precos[preco] || 0) + 1;
            }
          }
          const top = Object.entries(precos).sort((a,b)=>b[1]-a[1]);
          if (top.length > 0) {
            const preco = parseFloat(top[0][0]);
            if (!lidos.includes(preco)) {
              const li = document.createElement("li");
              const btnAdd = document.createElement("button");
              const btnDel = document.createElement("button");

              btnAdd.textContent = `Adicionar R$ ${preco.toFixed(2)}`;
              btnAdd.onclick = () => {
                total += preco;
                totalDisplay.textContent = total.toFixed(2);
                lidos.push(preco);
                li.remove();
                ocrAtivo = true;
              };

              btnDel.textContent = "Excluir";
              btnDel.onclick = () => {
                li.remove();
                ocrAtivo = true;
              };

              li.appendChild(document.createTextNode("Produto detectado "));
              li.appendChild(btnAdd);
              li.appendChild(btnDel);
              lista.appendChild(li);
            } else {
              ocrAtivo = true;
            }
          } else {
            ocrAtivo = true;
          }
        })
        .catch(() => ocrAtivo = true);
    }

    setInterval(capturaOCRPrecos, 2000);
  </script>
</body>
</html>
