<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Smart Cart</title>

  <!-- OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>

  <!-- Fonte -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
/* =========================
   Smart Cart ‚Äì UI Refresh
   ========================= */

:root{
  --bg:#141a32;
  --bg-grad:
    radial-gradient(1200px 600px at 10% 10%, #1b2550 0%, transparent 60%),
    radial-gradient(900px 500px at 90% 20%, #123046 0%, transparent 55%),
    radial-gradient(1100px 700px at 50% 120%, #1b1f3c 0%, #141a32 60%);
  --card: rgba(28,32,60,0.85);
  --card-border: rgba(124,140,200,0.20);
  --text:#eef2ff;
  --muted:#aeb7d4;
  --ok:#34d399;
  --warn:#f5c56a;
  --err:#ff7a7a;
  --shadow: 0 10px 28px rgba(6,12,32,0.40), inset 0 1px rgba(255,255,255,0.05);

  --action-font: clamp(12px, 1.2vw, 14px);
  --action-pad-v: clamp(6px, 1vw, 8px);
  --action-pad-h: clamp(8px, 1.2vw, 10px);
  --control-min-h: 38px;
}

*{ box-sizing:border-box }
html,body{ height:100% }
body{
  margin:0; color:var(--text);
  font: 500 15px/1.55 "Inter", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  background: var(--bg); background-image: var(--bg-grad);
  -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
}

/* Header */
header{
  position: sticky; top:0; z-index:10;
  backdrop-filter: blur(12px);
  background: linear-gradient(180deg, rgba(10,14,32,0.65), rgba(10,14,32,0.25));
  border-bottom: 1px solid var(--card-border);
}
.wrap{
  max-width:1200px; margin:0 auto; padding:14px 18px;
  display:flex; justify-content:center; position:relative;
}
.brand{ display:flex; align-items:center; gap:12px; }
.logo{
  width:34px; height:34px; border-radius:10px;
  background: linear-gradient(135deg, #7fb4ff, #34d399);
  box-shadow: 0 6px 18px rgba(127,180,255,0.35);
  display:grid; place-items:center;
}
.logo svg{ width:20px; height:20px; stroke:#ffffff; }
h1{ font-size:18px; font-weight:700; margin:0; letter-spacing:.2px }

/* Bot√£o hist√≥rico no cabe√ßalho (√≠cone, canto esquerdo) */
.icon-btn{
  position:absolute; left:12px; top:50%; transform:translateY(-50%);
  border:1px solid var(--card-border);
  background: linear-gradient(180deg, rgba(14,20,42,0.85), rgba(10,16,34,0.85));
  color:var(--text);
  padding:8px 10px; border-radius:10px; cursor:pointer;
  box-shadow: 0 6px 16px rgba(6,12,32,0.25);
  line-height:1; display:flex; align-items:center; justify-content:center;
}
.icon-btn:hover{ filter:brightness(1.03); transform:translateY(-50%) translateY(-1px); }
.icon-btn:active{ filter:brightness(0.98); transform:translateY(-50%); }

/* Layout principal */
main{
  max-width:1200px; margin:18px auto; padding:0 14px;
  display:grid; grid-template-columns:1.6fr 1fr; gap:16px;
}
@media (max-width:980px){ main{ grid-template-columns:1fr } }

.card{
  background: var(--card);
  border: 1px solid var(--card-border);
  border-radius: 16px;
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  box-shadow: var(--shadow);
  padding: 14px;
}
.stack{ display:flex; flex-direction:column; gap:12px }

/* C√¢mera */
.videoWrap{
  position: relative; border-radius: 14px; overflow: hidden;
  border: 1px solid var(--card-border); background: rgba(0,0,0,0.28);
  aspect-ratio: 16/9; box-shadow: var(--shadow);
  cursor: pointer;
}
@media (max-width:980px){ .videoWrap{ aspect-ratio:auto; height:56vh } }
video{ width:100%; height:100%; object-fit:cover; display:block; }
#overlay{ position:absolute; inset:0; width:100%; height:100%; pointer-events:none; }

/* HUD */
.hud{ position:absolute; left:10px; bottom:10px; display:flex; gap:8px; flex-wrap:wrap; }
.tag{
  background: rgba(12,18,40,0.6); border: 1px solid var(--card-border);
  color:var(--muted); padding: 6px 8px; font-size:12px; border-radius: 10px; backdrop-filter: blur(6px);
}

/* Coluna direita */
.title{ font-size:13px; color:var(--muted); letter-spacing:.4px; text-transform:uppercase }
#precos{ display:flex; flex-direction:column; gap:10px; max-height:48vh; overflow:auto; padding-right:4px; }

/* Sugest√µes de pre√ßo */
.preco-btn{
  font-size:1.08em; font-weight:700; padding:12px 14px;
  background: linear-gradient(180deg, rgba(26,44,32,0.95), rgba(18,33,24,0.92));
  color:#dfffee; border:1px solid rgba(72,140,92,0.55); border-radius:14px; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
  transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease, filter .12s ease;
  box-shadow: 0 6px 16px rgba(7,20,12,0.38);
  white-space: nowrap;
}
.preco-btn:hover{ transform: translateY(-1px); box-shadow: 0 12px 26px rgba(7,20,12,0.45); filter: brightness(1.03); }
.preco-btn.pulse{ transform: scale(1.04) }

/* Inputs/bot√µes base */
.input{
  border:1px solid var(--card-border); background: rgba(10,14,32,0.55);
  color:var(--text); padding: 10px 12px; border-radius:12px; outline:none;
  transition: border-color .12s ease, box-shadow .12s ease, background .12s ease;
  min-height:var(--control-min-h);
}
.input:focus-visible{
  border-color: rgba(127,180,255,0.65);
  box-shadow: 0 0 0 3px rgba(127,180,255,0.18);
  background: rgba(10,14,32,0.65);
}
.input-qty{ text-align:center; }
input[type=number]::-webkit-outer-spin-button,
input[type=number]::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0; }
input[type=number]{ -moz-appearance:textfield; }

/* Bot√µes */
.btn{
  border:1px solid var(--card-border);
  background: linear-gradient(180deg, rgba(14,20,42,0.85), rgba(10,16,34,0.85));
  color:var(--text);
  padding:10px 12px; border-radius:12px; cursor:pointer;
  transition: transform .12s ease, background .12s ease, border-color .12s ease, box-shadow .12s ease, filter .12s ease;
  box-shadow: 0 6px 16px rgba(6,12,32,0.25);
  min-height:var(--control-min-h);
  white-space: nowrap;
}
.btn:hover{ transform: translateY(-1px); filter: brightness(1.03); }
.btn:active{ transform: translateY(0); filter: brightness(0.98); }
.btn:focus-visible{ outline:none; box-shadow: 0 0 0 3px rgba(127,180,255,0.25); }

.btn.ok{
  background: linear-gradient(180deg, rgba(22,56,42,0.95), rgba(18,44,34,0.95));
  border-color: rgba(52,211,153,0.55); color:#e8fff6;
}
.btn.warn{
  background: linear-gradient(180deg, rgba(58,46,20,0.95), rgba(42,32,14,0.95));
  border-color: rgba(245,197,106,0.55); color:#fff3da;
}
.btn.err{
  background: linear-gradient(180deg, rgba(64,28,28,0.96), rgba(40,18,18,0.96));
  border-color: rgba(255,122,122,0.55); color:#ffecec;
}

/* Grids/linhas */
.row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }

/* Linha 1: [+] [Valor] [‚Äì] */
.manual-actions{
  display:grid;
  grid-template-columns: 1fr 1.4fr 1fr;
  gap:10px;
  align-items:stretch;
}
.manual-actions > *{ min-width:0; }

/* Linha 2: Qtd / √ó Mult. / üßπ Zerar / ‚Ü©Ô∏è Desfazer / (espa√ßo) */
.actions-grid-5{
  display:grid;
  grid-template-columns: 1fr 1fr 1.2fr 1.2fr 0.0001fr;
  gap:8px;
  align-items:stretch;
}
.actions-grid-5 > *{
  min-width:0; width:100%; height:100%;
  font-size: var(--action-font);
  padding: var(--action-pad-v) var(--action-pad-h);
}

/* Total */
#total{
  font-size: 1.8em; color:#c8f7da; display:flex; align-items:center; justify-content:space-between;
  padding-top:8px; margin-top:6px; border-top:1px dashed var(--card-border);
}

/* Tip */
.tip{ font-size:13px; color:var(--muted); border-left:3px solid rgba(127,180,255,0.45); padding-left:10px; }

/* Modal */
.modal{
  position: fixed; inset: 0; display:none; align-items:center; justify-content:center;
  background: rgba(5,8,20,0.55); backdrop-filter: blur(8px); z-index: 999;
}
.modal.show{ display:flex }
.modal-card{
  width:min(800px, 92vw); background: var(--card); border: 1px solid var(--card-border);
  border-radius:16px; box-shadow: var(--shadow); padding: 12px; display:flex; flex-direction:column; max-height:90vh;
}
.modal-head{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  padding:6px 6px 10px 6px; border-bottom: 1px dashed var(--card-border);
}
.modal-title{ font-weight:700; letter-spacing:.3px }
.modal-body{ overflow:auto; padding-top:10px; }

.modal-foot{
  border-top:1px dashed var(--card-border);
  margin-top:10px; padding:10px;
  position:sticky; bottom:0; background:var(--card);
  display:grid; grid-template-columns: 1fr auto auto; gap:8px; align-items:center;
}
.foot-input{ flex:1; min-width:0; }
@media (max-width:600px){
  .modal-foot{ grid-template-columns: 1fr; }
  .modal-foot .btn, .foot-input{ width:100%; justify-self:stretch; }
}

/* Hist√≥rico */
.hist{ display:flex; flex-direction:column; gap:8px; }
.hist-item{
  display:flex; align-items:center; justify-content:space-between; gap:8px;
  padding:10px 12px; border:1px solid var(--card-border); border-radius:12px; background: rgba(10,14,32,0.55);
}
.hist-left{ display:flex; align-items:center; gap:10px; }
.pill{ padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid var(--card-border); }
.pill.add{ color:#d9ffe9; background: rgba(24,42,30,0.7); border-color: rgba(72,140,92,0.45) }
.pill.sub{ color:#ffe0e0; background: rgba(52,24,24,0.6); border-color: rgba(164,74,74,0.45) }

/* Feed */
#feedScroll{ overflow: auto; }
.feed{ display:flex; flex-direction:column; gap:12px; }
.post{
  border:1px solid var(--card-border); border-radius:14px; background: rgba(8,12,28,0.55);
  overflow:hidden;
}
.post-img{ width:100%; display:block; object-fit:cover; max-height:420px; }
.post-body{ padding:10px 12px; display:flex; flex-direction:column; gap:8px; }
.post-title{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
.price{ font-weight:700; font-size:1.2rem; color:#c5f8d7; }
.loc{ font-size:12px; color:var(--muted); }
.actions{ display:flex; gap:8px; flex-wrap:wrap; }
.btn-ghost{
  background: rgba(8,12,28,0.35); border:1px solid var(--card-border);
  color:var(--text); padding:8px 10px; border-radius:10px; cursor:pointer;
}
.btn-ghost[disabled]{ opacity:.5; cursor:not-allowed }

.msg{
  border:1px solid var(--card-border); border-radius:14px; background: rgba(8,12,28,0.5);
  padding:10px 12px; display:flex; flex-direction:column; gap:6px;
}
.msg-text{ white-space:pre-wrap; }
.msg-meta{ font-size:12px; color:var(--muted); display:flex; gap:10px; align-items:center; }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="wrap">
      <!-- √çcone do Hist√≥rico (esquerda) -->
      <button class="icon-btn" onclick="abrirHistorico(event)" title="Hist√≥rico">üìú</button>

      <!-- Marca central -->
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round" role="img" aria-label="Carrinho de compras">
            <circle cx="9" cy="21" r="1"></circle>
            <circle cx="20" cy="21" r="1"></circle>
            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h7.72a2 2 0 0 0 2-1.61L23 6H6"></path>
          </svg>
        </div>
        <h1>Smart Cart</h1>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main>
    <!-- Esquerda: c√¢mera + HUD -->
    <section class="card stack">
      <div class="videoWrap" title="Toque para iniciar a c√¢mera se necess√°rio">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="overlay"></canvas>
        <div class="hud">
          <span class="tag">Mire a etiqueta dentro do ret√¢ngulo (50% √ó 20%)</span>
        </div>
      </div>
      <div class="tip">A leitura ocorre automaticamente ~a cada 1,2s. Use a c√¢mera traseira e mantenha a etiqueta bem enquadrada. Toque na √°rea da c√¢mera se ela n√£o iniciar automaticamente.</div>
    </section>

    <!-- Direita: sugest√µes + controles + total -->
    <aside class="card stack">
      <div class="title">Sugest√µes de pre√ßo</div>
      <div id="precos"></div>

      <!-- Linha 1: [+] [Valor] [‚Äì] -->
      <div class="manual-actions">
        <button class="btn ok" onclick="adicionarManual()" title="Somar valor">‚ûï Adicionar</button>
        <input id="manualInput" class="input" type="number" step="0.01" placeholder="Valor (ex: 0.77)">
        <button class="btn warn" onclick="diminuirManual()" title="Subtrair valor">‚ûñ Subtrair</button>
      </div>

      <!-- Linha 2: Qtd / √ó Mult. / üßπ Zerar / ‚Ü©Ô∏è Desfazer / (vazio) -->
      <div class="actions-grid-5">
        <input id="qtyInput" class="input input-qty" type="number" step="1" min="1" value="2" placeholder="Qtd.">
        <button class="btn" onclick="multiplicarManual()">√ó Mult.</button>
        <button class="btn err" onclick="zerarTotal()">üßπ Zerar</button>
        <button class="btn warn" onclick="desfazerUltimo()">‚Ü©Ô∏è Desfazer</button>
        <!-- vazio para balancear o grid -->
      </div>

      <!-- Linha 3: utilidades -->
      <div class="row">
        <button class="btn" onclick="abrirFeed(event)">üîé Radar de pre√ßos</button>
      </div>

      <div id="total">
        <span>Total</span>
        <span>R$ <span id="soma">0.00</span></span>
      </div>
    </aside>
  </main>

  <!-- Modal Hist√≥rico -->
  <div id="historicoModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="histTitle">
    <div class="modal-card">
      <div class="modal-head">
        <div class="modal-title" id="histTitle">Hist√≥rico de lan√ßamentos</div>
        <div style="display:flex; gap:8px">
          <button class="btn" onclick="fecharHistorico()">‚úñ Fechar</button>
        </div>
      </div>
      <div class="modal-body">
        <div id="historicoLista" class="hist"></div>
      </div>
    </div>
  </div>

  <!-- Modal Feed -->
  <div id="feedModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="feedTitle">
    <div class="modal-card">
      <div class="modal-head">
        <div class="modal-title" id="feedTitle"><!-- t√≠tulo removido --></div>
        <div style="display:flex; gap:8px">
          <button class="btn" onclick="fecharFeed()">‚úñ Fechar</button>
        </div>
      </div>
      <div class="modal-body" id="feedScroll">
        <div id="feedLista" class="feed"></div>
      </div>
      <div class="modal-foot">
        <input id="chatInput" class="input foot-input" type="text" placeholder="Escreva uma mensagem..." />
        <button class="btn" onclick="abrirPickerFoto()">üì∑ Foto</button>
        <button class="btn ok" onclick="enviarMensagem()">üì® Enviar</button>
        <input id="photoInput" type="file" accept="image/*" capture="environment" style="display:none" />
      </div>
    </div>
  </div>

  <!-- Audio -->
  <audio id="bip-audio" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>

  <!-- JS -->
  <script>
    /* ==== Cloud sync (Workers) ==== */
    const SYNC_TO_CLOUD = false;
    const API_BASE = "https://smartcart-chat.SEU_SUBDOMINIO.workers.dev";

    // id √∫nico do aparelho
    const DID_KEY = 'sc_device_id';
    let deviceId = localStorage.getItem(DID_KEY);
    if (!deviceId) {
      deviceId = Date.now() + '_' + Math.random().toString(36).slice(2,10);
      localStorage.setItem(DID_KEY, deviceId);
    }

    /* ===== C√¢mera / elementos ===== */
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const precosDiv = document.getElementById('precos');
    const somaSpan = document.getElementById('soma');
    const bip = document.getElementById('bip-audio');

    /* ===== Hist√≥rico sess√£o ===== */
    const historico = []; // {tipo:'add'|'sub', valor, data, total}
    function registrar(tipo, valor){ historico.unshift({ tipo, valor, data: new Date(), total }); }

    let total = 0;
    let canvas = document.createElement('canvas');
    let isProcessing = false;
    let valoresAdicionados = [];
    let sugestoesFixas = false;

    // OCR cooldown / TTL
    let lastSuggestionsAt = 0;
    const SUGGESTIONS_COOLDOWN = 1200;
    const SUGGESTIONS_TTL_MS   = 8000;

    // ROI
    const roi = { x:0, y:0, w:0, h:0 };

    function syncOverlayToVideo(){
      const rect = video.getBoundingClientRect();
      const dpr  = window.devicePixelRatio || 1;
      overlay.style.width  = rect.width + 'px';
      overlay.style.height = rect.height + 'px';
      overlay.width  = Math.round(rect.width  * dpr);
      overlay.height = Math.round(rect.height * dpr);
    }

    function desenharROI() {
      syncOverlayToVideo();
      const ctx = overlay.getContext('2d');
      ctx.clearRect(0, 0, overlay.width, overlay.height);
      const w = overlay.width  * 0.5;
      const h = overlay.height * 0.2;
      const x = (overlay.width  - w) / 2;
      const y = (overlay.height - h) / 2;
      roi.x = x; roi.y = y; roi.w = w; roi.h = h;
      const dpr = window.devicePixelRatio || 1;
      ctx.strokeStyle = 'rgba(255,255,255,0.95)';
      ctx.lineWidth = 3 * dpr;
      ctx.shadowColor = 'rgba(110,168,254,0.65)';
      ctx.shadowBlur = 8 * dpr;
      ctx.strokeRect(x, y, w, h);
      ctx.shadowBlur = 0;
    }

    /* ===== Persist√™ncia local ===== */
    const LS_KEYS = { total: 'sc_total', valores: 'sc_valores', historico: 'sc_hist', feed: 'sc_feed' };

    function saveState(){
      localStorage.setItem(LS_KEYS.total, String(total));
      localStorage.setItem(LS_KEYS.valores, JSON.stringify(valoresAdicionados));
      const histJSON = historico.map(h => ({...h, data: h.data instanceof Date ? h.data.toISOString() : h.data}));
      localStorage.setItem(LS_KEYS.historico, JSON.stringify(histJSON));
      saveFeed();
    }

    function loadState(){
      const t = parseFloat(localStorage.getItem(LS_KEYS.total));
      total = Number.isFinite(t) && t >= 0 ? t : 0;

      try {
        const vals = JSON.parse(localStorage.getItem(LS_KEYS.valores) || '[]');
        valoresAdicionados = Array.isArray(vals) ? vals.filter(v => typeof v === 'number') : [];
      } catch { valoresAdicionados = []; }

      try {
        const hist = JSON.parse(localStorage.getItem(LS_KEYS.historico) || '[]');
        historico.length = 0;
        hist.forEach(h => historico.push({
          tipo: h.tipo === 'sub' ? 'sub' : 'add',
          valor: Number(h.valor) || 0,
          data: h.data ? new Date(h.data) : new Date(),
          total: Number(h.total) || 0
        }));
      } catch {}

      somaSpan.innerText = total.toFixed(2);
      loadFeed();
    }

    /* ===== Config de envio autom√°tico ===== */
    const shareToChat = true;
    function mapsRoute(lat, lng){ return `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`; }

    /* ===== Controle OCR pausa/retoma ===== */
    let ocrPaused = false;
    function pauseOCR(v){
      ocrPaused = !!v;
      if (ocrPaused) limparSugestoes();
    }
    document.addEventListener('visibilitychange', ()=>{ pauseOCR(document.hidden); });

    /* ===== C√¢mera com fallback (traseira priorit√°ria) ===== */
    let currentStream = null;

    async function startWithConstraints(constraints){
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      if (currentStream){ currentStream.getTracks().forEach(t => t.stop()); }
      currentStream = stream;
      video.srcObject = stream;
      video.onloadedmetadata = () => { syncOverlayToVideo(); desenharROI(); };
      window.addEventListener('resize', syncOverlayToVideo);
      window.addEventListener('orientationchange', syncOverlayToVideo);
      return stream;
    }

    function looksLikeBackLabel(label){
      return /back|tr√°s|traseira|rear|environment|wide|ultra/i.test(label || '');
    }

    async function trySwitchToRearByDeviceId(){
      try{
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videos = devices.filter(d => d.kind === 'videoinput');
        let candidate = videos.find(d => looksLikeBackLabel(d.label));
        if (!candidate && videos.length) candidate = videos[videos.length - 1];
        if (candidate){
          const track = currentStream && currentStream.getVideoTracks()[0];
          const settings = track ? track.getSettings() : {};
          if (settings && settings.deviceId === candidate.deviceId) return;
          await startWithConstraints({ video: { deviceId: { exact: candidate.deviceId } }, audio:false });
        }
      }catch(e){ /* ignora troca se falhar */ }
    }

    async function iniciarCamera(){
      let lastErr;
      try{
        await startWithConstraints({ video: { facingMode: { exact: 'environment' } }, audio:false });
        await trySwitchToRearByDeviceId();
        return;
      }catch(e){ lastErr = e; }

      try{
        await startWithConstraints({ video: { facingMode: { ideal: 'environment' } }, audio:false });
        await trySwitchToRearByDeviceId();
        return;
      }catch(e){ lastErr = e; }

      try{
        await startWithConstraints({ video: true, audio:false });
        await trySwitchToRearByDeviceId();
        return;
      }catch(e){ lastErr = e; }

      try{
        await startWithConstraints({ video: true, audio:false });
        return;
      }catch(e){ lastErr = e; }

      console.warn("N√£o foi poss√≠vel iniciar a c√¢mera:", lastErr);
    }

    // Refor√ßos pra garantir a c√¢mera ligada
    async function ensureCamera(){
      try{
        // se n√£o h√° stream ou v√≠deo n√£o est√° pronto, tenta iniciar
        if (!video.srcObject || !video.srcObject.active || video.readyState < 2){
          await iniciarCamera();
        } else {
          // se track est√° "ended", reinicia
          const tracks = video.srcObject.getVideoTracks();
          if (!tracks.length || tracks[0].readyState === 'ended'){
            await iniciarCamera();
          }
        }
      }catch(e){
        // silencia tentativa; alguns navegadores exigem gesto
      }
    }

    // Alguns browsers (ex: Safari iOS) exigem gesto do usu√°rio
    function bindCameraAutostart(){
      const wrap = document.querySelector('.videoWrap');
      if (!wrap) return;
      const handler = async () => {
        await ensureCamera();
      };
      wrap.addEventListener('click', handler);
      wrap.addEventListener('touchstart', handler, { passive:true });
    }

    // Pingar de tempos em tempos pra reativar se cair
    setInterval(ensureCamera, 4000);
    window.addEventListener('focus', ensureCamera);

    // Permiss√µes (quando dispon√≠vel) ‚Äî ajuda a ‚Äúdestravar‚Äù em alguns navegadores
    (async ()=>{
      try{
        if (navigator.permissions && navigator.permissions.query){
          const res = await navigator.permissions.query({ name: 'camera' });
          res.onchange = ()=>{ if (res.state === 'granted') ensureCamera(); };
        }
      }catch(e){}
    })();

    /* ===== Somat√≥rio ===== */
    function adicionarPreco(valor, btn) {
      total += valor;
      valoresAdicionados.push(valor);
      somaSpan.innerText = total.toFixed(2);
      limparSugestoes(); sugestoesFixas = false; bip.play();
      if (btn) { btn.classList.add('pulse'); setTimeout(()=>btn.classList.remove('pulse'), 300); }
      registrar('add', valor);
      saveState();
      capturarEEnviarImagem(valor);
    }

    function multiplicarManual(){
      const input = document.getElementById('manualInput');
      const qtyEl = document.getElementById('qtyInput');
      let valor = parseFloat((input.value || '').replace(',', '.'));
      let qtd = parseInt(qtyEl.value, 10);

      if (isNaN(valor) || valor <= 0){
        alert('Digite primeiro um valor v√°lido em "Valor".');
        input.focus();
        return;
      }
      if (!Number.isInteger(qtd) || qtd < 1){
        alert('Quantidade inv√°lida. Use um n√∫mero inteiro ‚â• 1.');
        qtyEl.focus();
        return;
      }
      const resultado = valor * qtd;
      input.value = resultado.toFixed(2);

      input.style.transform = 'scale(1.02)';
      setTimeout(()=>{ input.style.transform = 'scale(1)'; }, 120);
    }

    function adicionarManual() {
      const input = document.getElementById('manualInput');
      const valor = parseFloat((input.value || '').replace(',', '.'));
      if (isNaN(valor) || valor <= 0) { alert("Digite um valor v√°lido em 'Valor'."); input.focus(); return; }
      total += valor; valoresAdicionados.push(valor);
      somaSpan.innerText = total.toFixed(2);
      limparSugestoes(); sugestoesFixas = false; bip.play();
      registrar('add', valor);
      saveState();
    }

    function diminuirManual() {
      const input = document.getElementById('manualInput');
      const valor = parseFloat((input.value || '').replace(',', '.'));
      if (isNaN(valor) || valor <= 0) { alert("Digite um valor v√°lido em 'Valor'."); input.focus(); return; }
      total -= valor; if (total < 0) total = 0;
      valoresAdicionados.push(-valor);
      somaSpan.innerText = total.toFixed(2);
      limparSugestoes(); sugestoesFixas = false; bip.play();
      registrar('sub', valor);
      saveState();
    }

    function zerarTotal() {
      total = 0; valoresAdicionados = [];
      somaSpan.innerText = total.toFixed(2); bip.play();
      historico.length = 0;
      localStorage.removeItem(LS_KEYS.total);
      localStorage.removeItem(LS_KEYS.valores);
      localStorage.removeItem(LS_KEYS.historico);
      saveFeed(); // n√£o apaga o chat
    }

    function desfazerUltimo() {
      if (valoresAdicionados.length > 0) {
        const valor = valoresAdicionados.pop();
        total -= valor; if (total < 0) total = 0;
        somaSpan.innerText = total.toFixed(2);
        saveState();
      }
    }

    function limparSugestoes() {
      precosDiv.innerHTML = '';
      sugestoesFixas = false;
    }

    /* ===== Hist√≥rico UI ===== */
    function abrirHistorico(e){
      if (e) e.stopPropagation(); pauseOCR(true);
      const el = document.getElementById('historicoModal');
      const lista = document.getElementById('historicoLista');
      lista.innerHTML = '';
      if (historico.length === 0){
        const vazio = document.createElement('div');
        vazio.className = 'hist-item';
        vazio.innerHTML = '<span class="hist-val">Nenhum lan√ßamento ainda</span><span class="hist-time">‚Äî</span>';
        lista.appendChild(vazio);
      } else {
        historico.forEach(item => {
          const row = document.createElement('div');
          row.className = 'hist-item';
          const tipoPill = `<span class="pill ${item.tipo === 'add' ? 'add' : 'sub'}">${item.tipo === 'add' ? 'Adicionar' : 'Diminuir'}</span>`;
          const valorFmt = (item.tipo === 'add' ? '+' : '-') + ' R$ ' + item.valor.toFixed(2);
          const dateFmt = item.data instanceof Date ? item.data.toLocaleString('pt-BR') : new Date(item.data).toLocaleString('pt-BR');
          row.innerHTML = `
            <div class="hist-left">
              ${tipoPill}
              <span class="hist-val">${valorFmt}</span>
            </div>
            <div class="hist-right">
              <div class="hist-time">${dateFmt}</div>
              <div class="hist-time">Total ap√≥s: R$ ${item.total.toFixed(2)}</div>
            </div>
          `;
          lista.appendChild(row);
        });
      }
      el.classList.add('show');
    }
    function fecharHistorico(){ document.getElementById('historicoModal').classList.remove('show'); pauseOCR(false); }
    document.getElementById('historicoModal').addEventListener('click', (e)=>{ if (e.target.id==='historicoModal') fecharHistorico(); });
    document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') { fecharHistorico(); fecharFeedInternal(); } });

    /* ===== OCR ===== */
    async function capturarImagemEProcessar() {
      if (ocrPaused || isProcessing || video.videoWidth === 0) return;
      isProcessing = true; desenharROI();
      const ctx = canvas.getContext('2d');

      const scaleX = video.videoWidth  / overlay.width;
      const scaleY = video.videoHeight / overlay.height;
      const roiWidth  = Math.round(roi.w * scaleX);
      const roiHeight = Math.round(roi.h * scaleY);
      const roiX      = Math.round(roi.x * scaleX);
      const roiY      = Math.round(roi.y * scaleY);

      const MAX_W = 600;
      let dw = roiWidth, dh = roiHeight;
      if (dw > MAX_W) { const s = MAX_W / dw; dw = Math.max(1, Math.round(dw*s)); dh = Math.max(1, Math.round(dh*s)); }
      canvas.width = dw; canvas.height = dh;

      if (ctx.filter !== undefined) ctx.filter = 'grayscale(1) contrast(115%)';
      ctx.drawImage(video, roiX, roiY, roiWidth, roiHeight, 0, 0, dw, dh);
      if (ctx.filter !== undefined) ctx.filter = 'none';

      try {
        const { data: { text } } = await Tesseract.recognize(canvas, 'eng');
        const matches = text.match(/\d{1,3}(?:[.,]\d{2})/g);
        if (matches) {
          const now = Date.now();
          if (now - lastSuggestionsAt >= SUGGESTIONS_COOLDOWN) {
            lastSuggestionsAt = now;
            limparSugestoes();
            matches.slice(0, 3).forEach(str => {
              const valor = parseFloat(str.replace(',', '.'));
              if (!isNaN(valor) && valor > 0) {
                const btn = document.createElement('div');
                btn.className = 'preco-btn';
                btn.innerText = `R$ ${valor.toFixed(2)}`;
                btn.onclick = () => adicionarPreco(valor, btn);
                precosDiv.appendChild(btn);
              }
            });
          }
        }
      } catch (e) { console.warn('OCR erro:', e); }
      finally { isProcessing = false; }
    }

    // Auto-expira√ß√£o de sugest√µes
    setInterval(()=>{
      const now = Date.now();
      if (!ocrPaused && precosDiv.childElementCount > 0 && (now - lastSuggestionsAt > SUGGESTIONS_TTL_MS)) {
        limparSugestoes();
      }
    }, 1000);

    /* ===== Feed ===== */
    const FEED_LIMIT = 200;
    let feed = []; // {type:'post'|'msg', ...}
    let feedOpen = false;

    function loadFeed(){
      try {
        const f = JSON.parse(localStorage.getItem(LS_KEYS.feed) || '[]');
        if (Array.isArray(f)) feed = f;
      } catch { feed = []; }
    }
    function saveFeed(){ localStorage.setItem(LS_KEYS.feed, JSON.stringify(feed)); }
    function pushFeed(item){
      feed.unshift(item);
      if (feed.length > FEED_LIMIT) feed.length = FEED_LIMIT;
      saveFeed();
    }

    function normalizePost(p){
      if (!p || p.type !== 'post') return p;
      if (typeof p.up !== 'number') p.up = 0;
      if (typeof p.down !== 'number') p.down = 0;
      if (!p.voters || typeof p.voters !== 'object') p.voters = {};
      return p;
    }

    function votar(postId, tipo){
      const idx = feed.findIndex(it => it.type === 'post' && it.id === postId);
      if (idx === -1) return;
      const p = normalizePost(feed[idx]);

      const prev = p.voters[deviceId];
      if (prev === tipo) return;

      if (prev === 'up' && p.up > 0) p.up--;
      if (prev === 'down' && p.down > 0) p.down--;

      if (tipo === 'up') p.up++;
      if (tipo === 'down') p.down++;

      p.voters[deviceId] = tipo;
      feed[idx] = p;
      saveFeed();
      renderFeed();
    }

    function getFeedScroller(){ return document.getElementById('feedScroll'); }
    function isNearBottom(el){ if (!el) return true; return (el.scrollHeight - el.scrollTop - el.clientHeight) < 40; }
    function jumpToBottom(){
      const scroller = getFeedScroller();
      if (!scroller) return;
      requestAnimationFrame(()=>{
        scroller.scrollTop = scroller.scrollHeight;
        requestAnimationFrame(()=>{ scroller.scrollTop = scroller.scrollHeight; });
      });
    }
    function maybeJumpToBottom(){
      const scroller = getFeedScroller();
      if (isNearBottom(scroller)) jumpToBottom();
    }

    async function abrirFeed(e){
      if (e) e.stopPropagation(); pauseOCR(true);

      if (SYNC_TO_CLOUD) {
        try {
          const res = await fetch(`${API_BASE}/api/feed?deviceId=${encodeURIComponent(deviceId)}`);
          const data = await res.json();
          if (data && data.ok && Array.isArray(data.posts)) {
            const newPosts = data.posts.map(p => normalizePost({
              type:'post',
              id: p.id,
              ts: p.ts,
              valor: p.valor,
              img: p.img,
              coords: p.coords || null,
              up: p.up || 0,
              down: p.down || 0,
              voters: p.voters || {}
            }));
            const msgs = feed.filter(it => it.type === 'msg');
            feed = [...newPosts, ...msgs].sort((a,b)=> new Date(b.ts) - new Date(a.ts));
            if (feed.length > FEED_LIMIT) feed.length = FEED_LIMIT;
            saveFeed();
          }
        } catch(e){ console.warn('cloud feed erro:', e); }
      }

      renderFeed();
      document.getElementById('feedModal').classList.add('show');
      feedOpen = true;
      history.pushState({feed:true}, '');
      jumpToBottom();
    }

    function fecharFeed(){ if (feedOpen) history.back(); }
    function fecharFeedInternal(){
      const modal = document.getElementById('feedModal');
      if (modal) modal.classList.remove('show');
      feedOpen = false;
      pauseOCR(false);
    }
    window.addEventListener('popstate', ()=>{ if (feedOpen){ fecharFeedInternal(); } });

    function renderFeed(){
      const lista = document.getElementById('feedLista');
      const scroller = getFeedScroller();
      const stick = isNearBottom(scroller);

      if (lista) lista.innerHTML = '';

      const items = [...feed].sort((a,b)=> new Date(a.ts) - new Date(b.ts));

      if (!items.length){
        const empty = document.createElement('div');
        empty.className = 'hist-item';
        empty.textContent = 'Envie uma mensagem ou poste uma foto abaixo.';
        lista.appendChild(empty);
      } else {
        items.forEach(p=>{
          if (p.type === 'msg'){
            const card = document.createElement('div');
            card.className = 'msg';
            const text = document.createElement('div');
            text.className = 'msg-text';
            text.textContent = p.text || '';
            const meta = document.createElement('div');
            meta.className = 'msg-meta';
            const when = new Date(p.ts).toLocaleString('pt-BR');
            meta.textContent = when + (p.coords ? ' ¬∑ com localiza√ß√£o' : '');
            const actions = document.createElement('div');
            actions.className = 'actions';
            const btnMap = document.createElement('button');
            btnMap.className = 'btn-ghost'; btnMap.textContent = 'üìç Rota';
            if (p.coords){ btnMap.onclick = ()=> window.open(mapsRoute(p.coords.lat, p.coords.lng), '_blank'); }
            else { btnMap.disabled = true; }
            const btnShare = document.createElement('button');
            btnShare.className = 'btn-ghost'; btnShare.textContent = 'üîó Compartilhar';
            btnShare.onclick = ()=> shareMessage(p);
            actions.appendChild(btnMap); actions.appendChild(btnShare);

            card.appendChild(text);
            card.appendChild(meta);
            card.appendChild(actions);
            lista.appendChild(card);
          } else {
            normalizePost(p);

            const card = document.createElement('div'); card.className = 'post';
            const img = document.createElement('img');
            img.className = 'post-img';
            img.src = p.img;
            img.alt = p.valor ? `Pre√ßo: R$ ${Number(p.valor).toFixed(2)}` : 'Foto enviada';
            img.loading = 'lazy';
            img.decoding = 'async';
            img.onload = () => { const scr = getFeedScroller(); if (isNearBottom(scr)) jumpToBottom(); };

            const body = document.createElement('div'); body.className = 'post-body';
            const title = document.createElement('div'); title.className='post-title';

            const left = document.createElement('div');
            if (typeof p.valor === 'number' && isFinite(p.valor) && p.valor > 0){
              const price = document.createElement('div'); price.className='price'; price.textContent = 'R$ ' + Number(p.valor).toFixed(2);
              left.appendChild(price);
            } else {
              const label = document.createElement('div'); label.className='loc'; label.textContent = 'üì∑ Foto';
              left.appendChild(label);
            }

            const when = document.createElement('div'); when.className='loc'; when.textContent = new Date(p.ts).toLocaleString('pt-BR') + (p.coords ? ' ¬∑ Com localiza√ß√£o' : ' ¬∑ Sem localiza√ß√£o');
            title.appendChild(left); title.appendChild(when);

            const actions = document.createElement('div'); actions.className='actions';
            const btnMap = document.createElement('button'); btnMap.className='btn-ghost'; btnMap.textContent='üìç Rota';
            if (p.coords){ btnMap.onclick = ()=> window.open(mapsRoute(p.coords.lat, p.coords.lng), '_blank'); }
            else { btnMap.disabled = true; }
            const btnShare = document.createElement('button'); btnShare.className='btn-ghost'; btnShare.textContent='üîó Compartilhar';
            btnShare.onclick = ()=> sharePost(p);
            actions.appendChild(btnMap); actions.appendChild(btnShare);

            const userVote = p.voters && p.voters[deviceId];
            const voteWrap = document.createElement('div');
            voteWrap.style.display = 'flex';
            voteWrap.style.alignItems = 'center';
            voteWrap.style.gap = '6px';

            const btnUp = document.createElement('button');
            btnUp.className = 'btn-ghost' + (userVote === 'up' ? ' active' : '');
            btnUp.textContent = 'üëç';
            btnUp.onclick = () => votar(p.id, 'up');

            const countSpan = document.createElement('span');
            countSpan.className = 'loc';
            countSpan.textContent = `${p.up || 0} ¬∑ ${p.down || 0}`;

            const btnDown = document.createElement('button');
            btnDown.className = 'btn-ghost' + (userVote === 'down' ? ' active' : '');
            btnDown.textContent = 'üëé';
            btnDown.onclick = () => votar(p.id, 'down');

            voteWrap.appendChild(btnUp);
            voteWrap.appendChild(countSpan);
            voteWrap.appendChild(btnDown);

            actions.appendChild(voteWrap);

            body.appendChild(title);
            body.appendChild(actions);

            card.appendChild(img); card.appendChild(body);
            lista.appendChild(card);
          }
        });
      }

      if (stick) jumpToBottom();
    }

    function sharePost(p){
      const precoTxt = (typeof p.valor === 'number' && isFinite(p.valor) && p.valor > 0) ? `Oferta: R$ ${Number(p.valor).toFixed(2)}\n` : '';
      const text = `${precoTxt}${p.coords ? `Mapa: ${mapsRoute(p.coords.lat, p.coords.lng)}` : ''}`.trim();
      try{
        if (navigator.share){
          navigator.share({ text: text || 'Foto do produto', title: 'Smart Cart', url: p.coords ? mapsRoute(p.coords.lat, p.coords.lng) : undefined });
        } else {
          const url = 'https://wa.me/?text=' + encodeURIComponent(text || 'Foto do produto');
          window.open(url, '_blank');
        }
      }catch(e){ console.warn('share erro:', e); }
    }
    function shareMessage(p){
      const text = `${p.text}${p.coords ? `\nMapa: ${mapsRoute(p.coords.lat, p.coords.lng)}` : ''}`;
      try{
        if (navigator.share){
          navigator.share({ text, title: 'Smart Cart' });
        } else {
          const url = 'https://wa.me/?text=' + encodeURIComponent(text);
          window.open(url, '_blank');
        }
      }catch(e){ console.warn('share erro:', e); }
    }

    /* ===== Enviar mensagem de texto ===== */
    function enviarMensagem(){
      const input = document.getElementById('chatInput');
      let text = (input.value || '').trim();
      if (!text) { input.blur(); return; }

      const id = Date.now() + '_' + Math.random().toString(36).slice(2,7);
      const ts = new Date().toISOString();

      const add = (coords)=> {
        pushFeed({ type:'msg', id, ts, text, coords: coords || null, author: deviceId });
        renderFeed();
        maybeJumpToBottom();
        input.value = '';
        input.blur();
      };

      if (navigator.geolocation){
        navigator.geolocation.getCurrentPosition(
          pos => add({ lat: pos.coords.latitude, lng: pos.coords.longitude } ),
          ()  => add(null),
          { enableHighAccuracy:true, timeout:7000 }
        );
      } else add(null);
    }

    /* ===== Bot√£o de foto no feed ===== */
    function abrirPickerFoto(){
      const input = document.getElementById('photoInput');
      if (!input) return;
      input.value = '';
      input.click();
    }

    document.getElementById('photoInput').addEventListener('change', async (e)=>{
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      await handleFotoSelecionada(file);
    });

    async function handleFotoSelecionada(file){
      try{
        const imgDataUrl = await fileToDataURL(file);
        const compressed = await compressImage(imgDataUrl, 1280);

        let priceRaw = prompt('Pre√ßo (opcional): ex. 10.50');
        let valor = null;
        if (priceRaw !== null){
          const v = parseFloat((priceRaw || '').replace(',', '.'));
          if (Number.isFinite(v) && v > 0) valor = v;
        }

        const postNow = (coords)=> {
          pushFeed({
            type:'post',
            id: Date.now() + '_' + Math.random().toString(36).slice(2,7),
            ts: new Date().toISOString(),
            valor: (valor !== null ? +valor : undefined),
            img: compressed,
            coords: coords || null,
            up: 0,
            down: 0,
            voters: {},
            author: deviceId
          });
          renderFeed();
          maybeJumpToBottom();
        };

        if (navigator.geolocation){
          navigator.geolocation.getCurrentPosition(
            pos => postNow({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
            ()  => postNow(null),
            { enableHighAccuracy:true, timeout:7000 }
          );
        } else { postNow(null); }

        if (SYNC_TO_CLOUD){
          try{
            await fetch(`${API_BASE}/api/post`, {
              method:'POST',
              headers:{ 'Content-Type':'application/json' },
              body: JSON.stringify({ deviceId, valor: (valor !== null ? +valor : null), coords: null, imageData: compressed })
            });
          }catch(e){ console.warn('cloud post erro:', e); }
        }

      }catch(e){
        console.warn('foto-picker erro:', e);
        alert('N√£o foi poss√≠vel processar a imagem.');
      }
    }

    function fileToDataURL(file){
      return new Promise((resolve, reject)=>{
        const fr = new FileReader();
        fr.onload = ()=> resolve(fr.result);
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }

    function compressImage(dataUrl, maxW){
      return new Promise((resolve)=>{
        const img = new Image();
        img.onload = ()=>{
          let w = img.width, h = img.height;
          if (w > maxW){
            const s = maxW / w;
            w = Math.round(w*s); h = Math.round(h*s);
          }
          const c = document.createElement('canvas');
          c.width = w; c.height = h;
          const ctx = c.getContext('2d');
          ctx.drawImage(img, 0, 0, w, h);
          const out = c.toDataURL('image/jpeg', 0.7);
          resolve(out);
        };
        img.onerror = ()=> resolve(dataUrl);
        img.src = dataUrl;
      });
    }

    /* ===== Captura foto + envia para feed ao somar ===== */
    async function capturarEEnviarImagem(valor) {
      try {
        const fullCanvas = document.createElement('canvas');
        fullCanvas.width = video.videoWidth;
        fullCanvas.height = video.videoHeight;
        fullCanvas.getContext('2d').drawImage(video, 0, 0);

        const maxW = 640;
        let tw = fullCanvas.width, th = fullCanvas.height;
        if (tw > maxW){ const s = maxW / tw; tw = Math.max(1, Math.round(tw*s)); th = Math.max(1, Math.round(th*s)); }
        const thumb = document.createElement('canvas');
        thumb.width = tw; thumb.height = th;
        thumb.getContext('2d').drawImage(fullCanvas, 0, 0, tw, th);
        const imageThumb = thumb.toDataURL('image/jpeg', 0.7);

        if (shareToChat) {
          navigator.geolocation.getCurrentPosition(async (position) => {
            const coords = { lat: position.coords.latitude, lng: position.coords.longitude };
            pushFeed({
              type:'post',
              id: Date.now() + '_' + Math.random().toString(36).slice(2,7),
              ts: new Date().toISOString(),
              valor: +valor,
              img: imageThumb,
              coords,
              up: 0,
              down: 0,
              voters: {},
              author: deviceId
            });
            renderFeed();
            maybeJumpToBottom();

            if (SYNC_TO_CLOUD) {
              try {
                await fetch(`${API_BASE}/api/post`, {
                  method: 'POST',
                  headers: { 'Content-Type':'application/json' },
                  body: JSON.stringify({ deviceId, valor:+valor, coords, imageData:imageThumb })
                });
              } catch(e){ console.warn('cloud post erro:', e); }
            }
          }, async () => {
            pushFeed({
              type:'post',
              id: Date.now() + '_' + Math.random().toString(36).slice(2,7),
              ts: new Date().toISOString(),
              valor: +valor,
              img: imageThumb,
              coords: null,
              up: 0,
              down: 0,
              voters: {},
              author: deviceId
            });
            renderFeed();
            maybeJumpToBottom();

            if (SYNC_TO_CLOUD) {
              try {
                await fetch(`${API_BASE}/api/post`, {
                  method: 'POST',
                  headers: { 'Content-Type':'application/json' },
                  body: JSON.stringify({ deviceId, valor:+valor, coords:null, imageData:imageThumb })
                });
              } catch(e){ console.warn('cloud post erro:', e); }
            }
          }, { enableHighAccuracy:true, timeout:7000 });
        }
      } catch (e) {
        console.warn('snapshot/geo erro:', e);
      }
    }

    // ===== Inicializa√ß√£o =====
    setInterval(capturarImagemEProcessar, 1200);
    // for√ßa a c√¢mera logo no carregamento
    (async ()=>{
      await ensureCamera();
      bindCameraAutostart();
    })();

    loadState();
  </script>
</body>
</html>
